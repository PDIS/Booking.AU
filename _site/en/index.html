<!DOCTYPE html>

<html lang="en">

	
<script src="../js/cookie.js"></script>

	<head>
    <title>Booking.AU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link href='../style/style.css' rel='stylesheet' />
  <link href='../style/fullcalendar.css' rel='stylesheet' />
  <link rel="stylesheet" type="text/css" href="../style/toastr.css">
  <link rel="stylesheet" type="text/css" href="../dist/semantic.css">
  <script src="../js/jquery.js"></script>
  <script src="../dist/semantic.min.js"></script>
  <script src="../js/moment.js"></script>
  <script src="../js/fullcalendar.js"></script>
  <script src="../js/toastr.js"></script>

  




</head>


<body>
	
<script type="text/javascript">
	//set Lng
		setCookie('Lng', 'en', 30);
	
</script> 
<!-- banner -->
<div class="ui fixed inverted menu">
	<div class="ui container">
		<a href="index.html" class="header item">
			<img class="logo" src="../images/pdis-logo.png">

		</a>

		<div class="right header item">
				<a href="../zh" style="padding-right: 5px;" >
					中文
				</a>
				|
				<a href="../en" style="padding-left: 5px;" >
					English
				</a>
				
			  </div>
	
	</div>
</div>
<!-- //banner --> 
<!-- mid -->




<script>
	$(function () {

		BindData();
	});


	function BindData() {
		var objEvents = [];
		$('#loading').css("display", "block")
		//兩天後~四個月
		var Wednesdays = getWednesday(3, new Date(moment().add(2, 'days')).getDate());

		//取得行程
		var settings = {
			"crossDomain": true,
			"url": "https://aucal.pdis.nat.gov.tw/getReserve",
			"method": "GET",
		}

		$.ajax(settings).done(function (response) {
			//console.log(response);
			var objBooking = (response);
			var objEvent = {

			};

			var eventTimes = [];

			objBooking.reservations.forEach(reservation => {


				objEvent = {
					date: moment(reservation.bufferedStartDate).format("YYYY-MM-DD"),
					title: reservation.title=="已預約"?'Reserved':reservation.title,
					start: moment(reservation.bufferedStartDate, "YYYY-MM-DDTHH:mm").add(8, 'hours'),
					end: moment(reservation.bufferedEndDate, "YYYY-MM-DDTHH:mm").add(8, 'hours'),
					color: '#fff',
					textColor: '#000',
					available: false
				}
				eventTimes.push(moment(reservation.bufferedStartDate, "YYYY-MM-DDTHH:mm").add(8, 'hours').format("YYYY-MM-DDTHH:mm"));
				objEvents.push(objEvent);


			});

			//可預約時段
			var availableTimespans = ["T14:00", "T15:00", "T16:00"];

			//判斷是否可預約，加入可預約時段
			Wednesdays.forEach(Wednesday => {
				availableTimespans.forEach(Timespan => {
					if ($.inArray((moment(Wednesday).format("YYYY-MM-DD") + Timespan), eventTimes) == -1) {
						objEvent = {
							title: "Available",
							start: moment(moment(Wednesday).format("YYYY-MM-DD") + Timespan + ":00+0800"),
							end: moment(moment(moment(Wednesday).format("YYYY-MM-DD") + Timespan + ":00+0800").add(40, 'minutes').format("YYYY-MM-DDTHH:mm")),
							color: '#fff',
							textColor: '#000',
							available: true
						}

						objEvents.push(objEvent);
					}
				});
			});




			//init
			$('#calendar').fullCalendar('destroy');
			$('#calendar').fullCalendar({
				eventRender: function (event, element) {

					if (event.available) {

						element.find(".fc-title").append("<i class='edit icon ' style='padding-left:10px;'></i>");
						element.addClass("available")
						element.find(".fc-title").addClass("available-bg")
					}
					else if (event.title == 'Reserved') {
						event.title = 'Reserved';
						element.find(".fc-title").addClass("NonReserve-bg")
					}
					else {

						element.find(".fc-title").addClass("Reserved-bg")
					}
				},
				eventClick: function (calEvent, jsEvent, view) {

					if (calEvent.available) {
						$('.ui.modal').modal('show');
						//$('.ui.form').form('reset');
						$('.ui.error.message').text('');
						$('#selectStart').text(moment(calEvent.start).format("YYYY-MM-DD HH:mm Z"));
						$('#selectEnd').text(moment(calEvent.end).format("YYYY-MM-DD HH:mm Z"));

					}
				},
				// header: {
				//   left: 'prev,next today',
				//   center: 'title',
				//   right: 'month,basicWeek,basicDay'
				// },
				buttonText: {
					today: 'Today',
					month: 'Month',
					week: 'Week',
					day: 'Day',
					list: 'List'
				},
				dayRender: function (date, cell) {
					cell.html("<div class='dayTitle'>" + date.format('M/D') + "</div>");
					var minDate = moment();
					if (date < minDate) {
						$(cell).parents('div.fc-row.fc-week.fc-widget-content').css('display', 'none');
						console.log($(cell).parents('div').find(".fc-row fc-week.fc-widget-content"))
					}
				},
				viewRender: function (currentView) {
					var minDate = moment(),
						maxDate = moment().add(2, 'months');



					// Past
					if (minDate >= currentView.start && minDate <= currentView.end) {
						$(".fc-prev-button").prop('disabled', true);
						$(".fc-prev-button").addClass('fc-state-disabled');
					}
					else {
						$(".fc-prev-button").removeClass('fc-state-disabled');
						$(".fc-prev-button").prop('disabled', false);
					}
					// Future
					if (maxDate >= currentView.start && maxDate <= currentView.end) {
						$(".fc-next-button").prop('disabled', true);
						$(".fc-next-button").addClass('fc-state-disabled');
					} else {

						$(".fc-next-button").removeClass('fc-state-disabled');
						$(".fc-next-button").prop('disabled', false);
					}

					$(".fc-prev-button").text("Prev");
					$(".fc-next-button").text("Next");
				},


				monthNames: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
				dayNamesShort: ['星期日', '星期一', '星期二', 'Wednesday', '星期四', '星期五', '星期六'],
				navLinks: false,
				defaultDate: new Date(),
				defaultView: 'month',
				height: 'auto',
				eventLimit: 6,
				eventBackgroundColor: '#074d71',
				timeFormat: 'h:mmt',
				hiddenDays: [1, 2, 4, 5, 6, 0],
				editable: false,
				// eventLimit: true, // allow "more" link when too many events
				validRange: {
					start: new Date(),
					end: '2018-06-01'
				},
				events: objEvents
			});

			$('#loading').css("display", "none")
		});

	}



</script>




<div class="ui main container" style="padding-top: 100px;">
	<div class="ui grid">
		<div class=" sixteen wide column">

			<div class="ui  card" style="width: 100%;">
				<div class="content">
					<div class="header">
						<i class="fc-icon-left-double-arrow"></i> Precautions</div>
				</div>
				<div class="content">
					<div class="ui small feed">
						<div class="event">
							<div class="content">
								<div class="summary">
										<p>The site only provides appointments from 14:00 to 17:00. To maintain the quality of the visit, each visit is based on <span style='color:red;'>40 minutes</span>. <p>If you cannot make an appointment, you are free to come from 10:00-14:00. The actual situation depends mainly on the scene, we apologize for any inconvenience caused.</p>The online calendar:<a href='http://silofficehour.pdis.tw'> http://silofficehour.pdis.tw</a></p>

								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>
		<div class=" ten wide column">

		</div>

	</div>
	<div class="ui grid">

		<div class=" sixteen wide column ">
			<div id="calendar" style="font-size: 16px "></div>
		</div>

	</div>
</div>



<div class="ui segment" id="loading" style="position: fixed;
	  height: 100%;
	  width: 100%;
	  top: 0px;
	  z-index: 99;
	  display:none;
	  opacity: 0.6;">
	<div class="ui active dimmer">
		<div class="ui medium text loader">Loading</div>
	</div>
	<p></p>
	<p></p>
</div>

<div class="ui modal ">

	<div class="header">
		Information
		<i class="close icon floatright" style='cursor: pointer;' onclick="$('.ui.modal').modal('hide');"></i>
	</div>
	<div class="ui form content">
		<div class="content">

			<div class="ui error message"></div>
			<div class="field">
				<label>Time</label>

				<span id="selectStart"></span> ～
				<div id="selectEnd"></div>

			</div>
			<div class="field">
				<label>Name</label>
				<input type="text" id="visitor_name" placeholder="Name">
			</div>
			<div class="field">
				<label>Email</label>
				<input type="text" id="visitor_email" placeholder="Email">
			</div>
			<div class="field">
				<label>Department</label>
				<input type="text" id="visitor_dept" placeholder="Department">
			</div>
			<div class="field">
				<label>Record mode</label>
				<input type="radio" id='radio_record1' name="record" value='錄影'>
				<label style='display: inline-table;' for="radio_record1">Video</label>

				<input type="radio" id='radio_record2' name="record" value='錄音'>
				<label style='display: inline-table;' for="radio_record2">Sound</label>

				<input type="radio" id='radio_record3' name="record" value='逐字稿'>
				<label style='display: inline-table;' for="radio_record3">Transcript</label>

			</div>
			<div class="field">
				<label>Description</label>
				<textarea rows="3" id="visitor_description"></textarea>
			</div>

			<div class="field floatright">
				<div class="ui clear button">Clear</div>
				<div class="ui positive right labeled icon submit button" onclick="submitbooking()">
						Submit
					<i class="checkmark icon"></i>
				</div>
			</div>
			<div class="field floatright">

				<hr/>
			</div>
		</div>

	</div>
</div>




<script>
	function submitbooking() {
		if (confirm('You cannot modify form after you send it. Are you sure to submit the form?')) {
			if ($('#selectEnd').text() == '' || $('#selectStart').text() == '' || $('#visitor_name').val() == '' || $('#visitor_email').val() == '' || $('#visitor_description').val() == '' || $('#visitor_dept').val() == '') {

			}
			else {
				// Request (POST https://aucal.pdis.nat.gov.tw/reserve)
				$('#loading').css("display", "block")
				$('.ui.modal').modal('hide');
				jQuery.ajax({
					url: "https://aucal.pdis.nat.gov.tw/reserve",
					type: "POST",
					headers: {
						"Content-Type": "application/json; charset=utf-8",
					},
					contentType: "application/json",
					data: JSON.stringify({
						"end": $('#selectEnd').text(),
						"start": $('#selectStart').text(),
						"username": $('#visitor_name').val(),
						"email": $('#visitor_email').val(),
						"description": $('#visitor_description').val() + "  記錄方式：" + $("input:radio[name ='record']:checked").val(),
						"department": $('#visitor_dept').val(),
						"name": $('#visitor_name').val() + " Reserve"
					})
				})
					.done(function (response, textStatus, jqXHR) {

						if (response.message.indexOf("errors") >= 0) {
							toastr.error(JSON.parse(response.message).message, 'Fail', { timeOut: 8000 })
						}
						else {
							toastr.info(JSON.parse(response.message).message, 'Success', { timeOut: 8000 })
						}


					})
					.fail(function (jqXHR, textStatus, errorThrown) {
						console.log("HTTP Request Failed");
						toastr.error("Server is busy, please try again!", 'Error', { timeOut: 5000 })
					})
					.always(function () {
						/* ... */
						$('#loading').css("display", "block");
						BindData();
					});
			}
		}
		else {
			return;
		}





	}

</script>

<script>


	//validation
	$('.ui.form')
		.form({
			fields: {
				visitor_name: {
					identifier: 'visitor_name',
					rules: [
						{
							type: 'empty',
							prompt: 'Please enter a username'
						}
					]
				}
				,
				visitor_email: {
					identifier: 'visitor_email',
					rules: [
						{
							type: 'email',
							prompt: 'Please enter an email'
						}
					]
				}
				,
				visitor_dept: {
					identifier: 'visitor_dept',
					rules: [
						{
							type: 'empty',
							prompt: ''
						}
					]
				}
				,
				visitor_description: {
					identifier: 'visitor_description',
					rules: [
						{
							type: 'empty',
							prompt: 'Please enter Description'
						}
					]
				},
				record: {
					identifier: 'record',
					rules: [{
						type: 'checked',
						prompt: 'Please select a record mode'
					}]
				},
			}
		});




	//取得所有禮拜三
	function getWednesday(monthCount, setfirstDate) {
		var d = new Date(),
			month = d.getMonth(),
			Wednesdays = [];

		d.setDate(setfirstDate);
		// Get the first Wednesday in the month
		while (d.getDay() !== 3) {
			d.setDate(d.getDate() + 1);
		}
		var tmpd = new Date();
		tmpd.setMonth(tmpd.getMonth() + monthCount);
		var endmonth = tmpd.getMonth();

		// Get all the other Wednesday in the month
		while (d.getMonth() !== endmonth) {
			Wednesdays.push(new Date(d.getTime()));
			d.setDate(d.getDate() + 7);
		}
		return Wednesdays;
	}

</script>



<!-- //mid --> 
<!--footer-->

<div class="ui inverted section divider"></div>
<div class="ui inverted vertical footer segment">
  <div class="ui center aligned container">


	<img src="../images/pdis-logo.png" class="ui centered mini image">
	<div class="ui horizontal inverted small divided link list">
	  <a class="item" target="_blank" href="https://jk.pdis.tw">Contact Us</a>
	  <a class="item" target="_blank" href="http://socialinnovationlab.iiiedu.org.tw/">Social Innovation Lab</a>
	</div>
  </div>
</div>




</body>
<script type="text/javascript">
	//set Lng
	var lng = getCookie('Lng');
	if (lng == null) {
		setCookie('Lng', navigator.language || navigator.userLanguage, 30);
		lng = navigator.language || navigator.userLanguage
	}


	if (lng == 'zh-TW') {
		if (window.location.pathname.toLowerCase() != '/zh/')
			window.location = "/zh/";
	} else {
		if (window.location.pathname.toLowerCase() != '/en/')
			window.location = "/en/";
	}
</script> 
</html>